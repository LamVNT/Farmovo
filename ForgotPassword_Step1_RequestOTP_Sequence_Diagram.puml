@startuml ForgotPassword_Step1_RequestOTP_Sequence_Diagram

!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequence {
    ArrowColor #495057
    ActorBorderColor #6C757D
    LifeLineBorderColor #6C757D
    ParticipantBorderColor #6C757D
    ParticipantBackgroundColor #F8F9FA
}

title **Forgot Password - Step 1: Request OTP**

actor User as U
participant "Frontend" as F
participant "ForgotPasswordController" as C
participant "UserRepository" as UR
participant "EmailServiceImpl" as ES
participant "ForgotPasswordRepository" as FPR

U -> F: Enter email address
F -> C: POST /verifyMail/{email}
activate C

C -> UR: findByEmail(email)
activate UR
UR --> C: User object
deactivate UR

alt Email not found
    C --> F: Error: "Email không tồn tại"
    F --> U: Display error message
else Email found
    C -> FPR: deleteByUserId(userId)
    activate FPR
    FPR --> C: Deleted old OTP
    deactivate FPR
    
    C -> C: otpGenerator()
    note right: Generate 6-digit OTP\n(100000-999999)
    
    C -> ES: sendSimpleMessage(mailBody)
    activate ES
    ES -> ES: Send email with OTP
    note right: Subject: "OTP for Forgot Password"\nText: "Mã OTP của bạn là: {otp}\nMã sẽ hết hạn trong 70 giây."
    ES --> C: Email sent
    deactivate ES
    
    C -> FPR: save(ForgotPassword)
    activate FPR
    FPR -> FPR: Save OTP with expiration time
    note right: expirationTime = now + 70 seconds
    FPR --> C: Saved OTP record
    deactivate FPR
    
    C --> F: Success response with expiration time
    F --> U: Display success message
end
deactivate C

@enduml

