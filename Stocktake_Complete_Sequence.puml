@startuml Stocktake_Complete_Sequence

skinparam backgroundColor white
skinparam sequenceArrowThickness 2
skinparam sequenceMessageAlign center
skinparam sequenceGroupBodyBackgroundColor #F8F9FA
skinparam sequenceParticipantBorderColor #6C757D
skinparam sequenceParticipantBackgroundColor #E9ECEF
skinparam sequenceLifeLineStroke dash

title Complete StockTake - Sequence Diagram (Status Change)

actor Staff
participant "StockTake Detail Page" as UI
participant ":StocktakeController" as CC
participant ":StocktakeServiceImpl" as CS
participant ":StocktakeRepository" as CR
participant ":StocktakeMapper" as CM

Staff -> UI : Nhấn 'Hoàn thành kiểm kê'
UI -> CC : PUT /api/stocktakes/{id}/status?status=COMPLETED
activate CC
CC -> CS : updateStocktakeStatus(id, COMPLETED, userId)
activate CS
CS -> CR : findById(id)
CR --> CS : Stocktake
CS -> CS : validateStatusTransition(old, COMPLETED, user)
CS -> CS : set status = COMPLETED
CS -> CR : save(stocktake)
CR --> CS : saved
CS -> CS : buildStocktakeResponseDto(saved)
note right
  - Trả về detail đã group
  - hasBalance = count PCB COMPLETE theo stocktakeId (tham chiếu động)
end note
CS -> CC : StocktakeResponseDto
CC -> UI : 200 OK
UI -> Staff : Hiển thị trạng thái COMPLETED + ẩn/hiện nút Cân bằng kho theo diff/hasBalance

@enduml 