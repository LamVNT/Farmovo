@startuml Create_StockTake_SequenceDiagram
skinparam {
  backgroundColor white
  sequenceArrowThickness 2
  sequenceMessageAlign center
  sequenceGroupBodyBackgroundColor #F8F9FA
  sequenceParticipantBorderColor #6C757D
  sequenceParticipantBackgroundColor #E9ECEF
  sequenceLifeLineStroke dash
}

title Create StockTake – Sequence Diagram

actor Staff
participant ":StockTake Page (View)" as UI
participant ":Create Stocktake UI (View)" as CreateUI
participant ":StocktakeController" as StocktakeCtrl
participant ":StocktakeServiceImpl" as StocktakeSvc
participant ":StocktakeMapper" as StocktakeMapper
participant ":StocktakeRepository" as StocktakeRepo
participant ":MasterDataController" as MasterDataCtrl
participant ":MasterDataService" as MasterDataSvc
participant ":MasterDataRepository" as MasterDataRepo

== A. Load dữ liệu ban đầu ==
Staff -> UI: Truy cập StockTake Page
activate Staff
activate UI

Staff -> UI: Nhấn "Tạo phiếu kiểm kê"
UI -> CreateUI: Điều hướng sang Create Stocktake Page
deactivate UI
activate CreateUI

CreateUI -> MasterDataCtrl: GET /api/master-data
activate MasterDataCtrl
MasterDataCtrl -> MasterDataSvc: getMasterData(userRole)
activate MasterDataSvc
MasterDataSvc -> MasterDataRepo: fetchAllMasterData()
activate MasterDataRepo
MasterDataRepo --> MasterDataSvc: MasterDataDTO
deactivate MasterDataRepo
MasterDataSvc --> MasterDataCtrl: MasterDataDTO {Products, Zones, Stores?, Categories}
deactivate MasterDataSvc
MasterDataCtrl --> CreateUI: MasterDataDTO
deactivate MasterDataCtrl

CreateUI --> Staff: Hiển thị form tạo kiểm kê với dữ liệu master

== B. Submit tạo mới StockTake ==
Staff -> CreateUI: Nhập thông tin phiếu kiểm kê
CreateUI -> StocktakeCtrl: POST /api/stocktakes {requestDto}
activate StocktakeCtrl
StocktakeCtrl -> StocktakeSvc: createStocktake(requestDto, userId)
activate StocktakeSvc

alt Dữ liệu không hợp lệ
    StocktakeSvc -> StocktakeSvc: validateStocktakeData(requestDto)
    note right: Kiểm tra dữ liệu thiếu/bị sai
    StocktakeSvc --> StocktakeCtrl: ValidationException
    StocktakeCtrl --> CreateUI: HTTP 400 + Error message
    CreateUI --> Staff: Hiển thị thông báo lỗi
else Dữ liệu hợp lệ
    StocktakeSvc -> StocktakeSvc: validateStocktakeData(requestDto)
    note right: Pass validation

    StocktakeSvc -> StocktakeMapper: toEntity(requestDto, userId)
    activate StocktakeMapper
    StocktakeMapper --> StocktakeSvc: StocktakeEntity
    deactivate StocktakeMapper

    StocktakeSvc -> StocktakeRepo: save(stocktake entity)
    activate StocktakeRepo
    StocktakeRepo --> StocktakeSvc: StocktakeEntity
    deactivate StocktakeRepo

    StocktakeSvc -> StocktakeMapper: toResponseDto(StocktakeEntity)
    activate StocktakeMapper
    StocktakeMapper --> StocktakeSvc: StocktakeResponseDto
    deactivate StocktakeMapper

    StocktakeSvc --> StocktakeCtrl: StocktakeResponseDto
    StocktakeCtrl --> CreateUI: HTTP 201 + StocktakeResponseDto
    CreateUI --> UI: Cập nhật trang StockTake
    UI --> Staff: Thông báo tạo thành công phiếu kiểm kê (Draft hoặc Completed)
end

deactivate StocktakeSvc
deactivate StocktakeCtrl
deactivate CreateUI
deactivate UI
deactivate Staff
@enduml
