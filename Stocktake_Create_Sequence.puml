@startuml Create_StockTake_SequenceDiagram

skinparam backgroundColor white
skinparam sequenceArrowThickness 2
skinparam sequenceMessageAlign center
skinparam sequenceGroupBodyBackgroundColor #F8F9FA
skinparam sequenceParticipantBorderColor #6C757D
skinparam sequenceParticipantBackgroundColor #E9ECEF
skinparam sequenceLifeLineStroke dash
skinparam actorBackgroundColor #FFD700

title Create StockTake – Sequence Diagram (Load + Create)

actor Staff
participant ":StockTake Page" as UI
participant ":Create Stocktake UI" as CreateUI
participant ":StocktakeController" as Controller
participant ":StocktakeServiceImpl" as Service
participant ":Product API (/products)" as ProductAPI
participant ":Zone API (/zones)" as ZoneAPI
participant ":Store API (/admin/storeList)" as StoreAPI
participant ":Category API (/categories)" as CategoryAPI
participant ":StocktakeRepository" as StocktakeRepo
participant ":StocktakeMapper" as Mapper

== A. Load dữ liệu ban đầu (Products/Zones/Categories/Stores) ==
Staff -> UI: Truy cập StockTake Page
activate Staff
activate UI

Staff -> UI: Nhấn "Tạo phiếu kiểm kê"
UI -> CreateUI: Điều hướng sang Create Stocktake Page
deactivate UI
activate CreateUI

alt User là Staff
  group Load Products/Zones/Categories
    CreateUI -> ProductAPI: GET /api/products
    ProductAPI --> CreateUI: List<ProductDTO>
    CreateUI -> ZoneAPI: GET /api/zones
    ZoneAPI --> CreateUI: List<ZoneDTO>
    CreateUI -> CategoryAPI: GET /api/categories
    CategoryAPI --> CreateUI: List<CategoryDTO>
  end
else User là Owner/Admin
  group Load Products/Zones/Stores/Categories
    CreateUI -> ProductAPI: GET /api/products
    ProductAPI --> CreateUI: List<ProductDTO>
    CreateUI -> ZoneAPI: GET /api/zones
    ZoneAPI --> CreateUI: List<ZoneDTO>
    CreateUI -> StoreAPI: GET /api/admin/storeList
    StoreAPI --> CreateUI: List<StoreDTO>
    CreateUI -> CategoryAPI: GET /api/categories
    CategoryAPI --> CreateUI: List<CategoryDTO>
  end
end

CreateUI --> Staff: Hiển thị form tạo kiểm kê với dữ liệu master

== B. Submit tạo mới StockTake (Draft hoặc Completed) ==
Staff -> CreateUI: Nhập thông tin phiếu kiểm kê
CreateUI -> Controller: POST /api/stocktakes {requestDto}
activate Controller
Controller -> Service: createStocktake(requestDto, userId)
activate Service
Service -> Mapper: toEntity(requestDto)
Mapper --> Service: Stocktake entity
Service -> StocktakeRepo: save(stocktake)
StocktakeRepo --> Service: saved entity
Service -> Mapper: toResponseDto(stocktake)
Mapper --> Service: StocktakeResponseDto
Service --> Controller: StocktakeResponseDto
deactivate Service
Controller --> CreateUI: 201 Created + StocktakeResponseDto
CreateUI --> UI: Cập nhật trang StockTake
UI --> Staff: Thông báo tạo thành công phiếu kiểm kê (Draft hoặc Completed)

deactivate Controller
deactivate CreateUI
deactivate UI
deactivate Staff

@enduml
