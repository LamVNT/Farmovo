@startuml Stocktake_Update_Short_Full_Lifeline

skinparam backgroundColor white
skinparam sequenceArrowThickness 2
skinparam sequenceMessageAlign center
skinparam sequenceGroupBodyBackgroundColor #F8F9FA
skinparam sequenceParticipantBorderColor #6C757D
skinparam sequenceParticipantBackgroundColor #E9ECEF
skinparam sequenceLifeLineStroke dash

title Update Stocktake

actor Staff
participant ":StockTake Page" as ListUI
participant ":Stocktake Edit Page" as EditUI
participant ":StocktakeController" as Controller
participant ":StocktakeServiceImpl" as Service
participant ":StocktakeRepository" as Repo
participant ":StocktakeMapper" as Mapper
participant ":MasterDataController" as MasterDataCtrl
participant ":MasterDataService" as MasterDataSvc
participant ":MasterDataRepository" as MasterDataRepo

== A. Load dữ liệu ban đầu ==
activate Staff
Staff -> ListUI: Chọn phiếu DRAFT → "Cập nhật"
activate ListUI
ListUI -> EditUI: Điều hướng /edit/{id}
deactivate ListUI
activate EditUI

EditUI -> MasterDataCtrl: GET /api/master-data
activate MasterDataCtrl
MasterDataCtrl -> MasterDataSvc: getMasterData(userRole)
activate MasterDataSvc
MasterDataSvc -> MasterDataRepo: fetchAllMasterData()
activate MasterDataRepo
MasterDataRepo --> MasterDataSvc: MasterDataDTO
deactivate MasterDataRepo
MasterDataSvc --> MasterDataCtrl: MasterDataDTO {Products, Zones, Stores?, Categories}
deactivate MasterDataSvc
MasterDataCtrl --> EditUI: MasterDataDTO
deactivate MasterDataCtrl

EditUI --> Staff: Hiển thị form + dữ liệu master

== B. Load Stocktake & Details ==
EditUI -> Controller: GET /api/stocktakes/{id}
activate Controller
Controller -> Service: getStocktakeById(id)
activate Service
Service -> Repo: findById(id)
activate Repo
Repo --> Service: Optional<Stocktake>
deactivate Repo
alt Không tìm thấy
    Service --> Controller: throw ValidationException("Stocktake not found")
    Controller --> EditUI: 404 Not Found
    EditUI --> Staff: Hiển thị lỗi
    deactivate Service
    deactivate Controller
else Tìm thấy
    Service -> Mapper: toResponseDto(stocktake)
    activate Mapper
    Mapper --> Service: StocktakeResponseDto
    deactivate Mapper
    Service --> Controller: StocktakeResponseDto
    deactivate Service
    Controller --> EditUI: 200 OK
    deactivate Controller
    EditUI --> Staff: Hiển thị dữ liệu phiếu để chỉnh sửa
end

== C. Load Lots theo filter (tùy chọn) ==
opt Có filter
  EditUI -> Controller: GET /api/stocktakes/products-by-zone?zoneId=...
  activate Controller
  Controller --> EditUI: List<ProductResponseDto>
  deactivate Controller
end

== D. Submit Update ==
Staff -> EditUI: Nhấn "Lưu nháp"/"Hoàn thành"
EditUI -> Controller: PUT /api/stocktakes/{id} {requestDto}
activate Controller
Controller -> Service: updateStocktake(id, requestDto)
activate Service

Service -> Service: validate request (status/editable rules)
alt Không hợp lệ
  Service --> Controller: ValidationException
  Controller --> EditUI: 400 Bad Request
  EditUI --> Staff: Hiển thị lỗi
  deactivate Service
  deactivate Controller
else Hợp lệ
  Service -> Repo: findById(id)
  activate Repo
  Repo --> Service: Stocktake
  deactivate Repo
  Service -> Mapper: mergeFromDto(stocktake, requestDto)
  activate Mapper
  Mapper --> Service: Stocktake (merged)
  deactivate Mapper
  Service -> Service: updateStocktakeDetails(...)
  Service -> Repo: save(stocktake)
  activate Repo
  Repo --> Service: saved
  deactivate Repo
  Service -> Mapper: toResponseDto(saved)
  activate Mapper
  Mapper --> Service: StocktakeResponseDto
  deactivate Mapper
  Service --> Controller: StocktakeResponseDto
  deactivate Service
  Controller --> EditUI: 200 OK
  deactivate Controller
  EditUI --> Staff: Thông báo thành công + điều hướng về danh sách
end

deactivate EditUI
deactivate Staff

note right of EditUI
  Không update tồn kho ở đây.
  Cân bằng kho sẽ qua PCB sau khi COMPLETED.
end note

@enduml
