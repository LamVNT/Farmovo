@startuml Stocktake_Update_Short_Full_Lifeline

skinparam backgroundColor white
skinparam sequenceArrowThickness 2
skinparam sequenceMessageAlign center
skinparam sequenceGroupBodyBackgroundColor #F8F9FA
skinparam sequenceParticipantBorderColor #6C757D
skinparam sequenceParticipantBackgroundColor #E9ECEF
skinparam sequenceLifeLineStroke dash
skinparam actorBackgroundColor #FFD700

title Update Stocktake

actor User
participant "StockTake Page" as ListUI
participant "Stocktake Edit Page" as EditUI
participant "StocktakeController" as Controller
participant "StocktakeService" as Service
participant "StocktakeRepo" as Repo
participant "APIs (Products/Zones/Stores/Categories)" as MasterAPI
participant "ImportDetail API" as LotAPI

== A. Prefetch Master Data ==
activate User
User -> ListUI: Chọn phiếu DRAFT → "Cập nhật"
activate ListUI
par Products
  ListUI -> MasterAPI: GET /api/products
  activate MasterAPI
  MasterAPI --> ListUI: List<ProductDTO>
  deactivate MasterAPI
else Zones
  ListUI -> MasterAPI: GET /api/zones
  activate MasterAPI
  MasterAPI --> ListUI: List<ZoneDTO>
  deactivate MasterAPI
else Stores (Owner/Admin)
  ListUI -> MasterAPI: GET /api/admin/storeList
  activate MasterAPI
  MasterAPI --> ListUI: List<StoreDTO>
  deactivate MasterAPI
else Categories
  ListUI -> MasterAPI: GET /api/categories
  activate MasterAPI
  MasterAPI --> ListUI: List<CategoryDTO>
  deactivate MasterAPI
end
ListUI -> EditUI: Điều hướng /edit/{id} (truyền cache)
deactivate ListUI
activate EditUI

== B. Load Stocktake & Details ==
EditUI -> Controller: GET /stocktakes/{id}
activate Controller
Controller -> Service: getStocktakeById
activate Service
Service -> Repo: findById
activate Repo
Repo --> Service: entity
deactivate Repo
Service --> Controller: StocktakeResponseDto
deactivate Service
Controller --> EditUI: 200 OK
deactivate Controller

== C. Load Lots theo filter ==
opt Có filter
  EditUI -> LotAPI: GET /stocktake-lot
  activate LotAPI
  LotAPI --> EditUI: List<LotDTO>
  deactivate LotAPI
end

== D. User chỉnh sửa ==
User -> EditUI: Nhập Real, tick check, đổi filter
opt Đổi filter
  EditUI -> LotAPI: GET /stocktake-lot
  activate LotAPI
  LotAPI --> EditUI: List<LotDTO>
  deactivate LotAPI
end

== E. Submit Update ==
User -> EditUI: Nhấn "Lưu nháp"/"Hoàn thành"
EditUI -> Controller: PUT /stocktakes/{id}
activate Controller
Controller -> Service: updateStocktake
activate Service
Service -> Repo: save
activate Repo
Repo --> Service: saved entity
deactivate Repo
Service --> Controller: Updated DTO
deactivate Service
Controller --> EditUI: 200 OK
deactivate Controller
EditUI --> User: Thông báo thành công + điều hướng về danh sách

== F. (Optional) Đổi trạng thái ==
User -> EditUI: PUT /status?status=...
EditUI -> Controller: updateStocktakeStatus
activate Controller
Controller -> Service: validate & save
activate Service
Service -> Repo: save
activate Repo
Repo --> Service: saved entity
deactivate Repo
Service --> Controller: Updated DTO
deactivate Service
Controller --> EditUI: 200 OK
deactivate Controller
EditUI --> User: Thông báo đổi trạng thái thành công

deactivate EditUI
deactivate User

note right of EditUI
  Không update tồn kho ở đây.
  Cân bằng kho xử lý qua PCB sau khi COMPLETED.
end note

@enduml
