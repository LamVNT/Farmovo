@startuml Stocktake_Update_Sequence

skinparam backgroundColor white
skinparam sequenceArrowThickness 2
skinparam sequenceMessageAlign center
skinparam sequenceGroupBodyBackgroundColor #F8F9FA
skinparam sequenceParticipantBorderColor #6C757D
skinparam sequenceParticipantBackgroundColor #E9ECEF
skinparam sequenceLifeLineStroke dash

title Update StockTake - Sequence Diagram

actor User
participant "StockTake Page" as UI
participant ":StocktakeController" as CC
participant ":StocktakeServiceImpl" as CS
participant ":StocktakeValidator" as CV
participant ":StocktakeMapper" as CM
participant ":StocktakeRepository" as CR
database "Database" as DB

User -> UI : Chọn kiểm kê cần cập nhật, nhấn 'Cập nhật'
UI -> CC : PUT /api/stocktakes/{id} {stocktakeDate, detail, note, storeId}
activate CC

CC -> CV : validate(requestDto)
activate CV
CV -> CV : validate fields
CV --> CC : return validation result
deactivate CV

alt Validation Failed
    CC --> UI : return 400 Bad Request {error message}
    UI --> User : return error
else Validation Passed
    CC -> CS : updateStockTake(id, requestDto)
    activate CS
    CS -> CR : findById(id)
    activate CR
    CR -> DB : SELECT * FROM stocktakes WHERE id = ?
    DB --> CR : return Stocktake or null
    CR --> CS : return Optional<Stocktake>
    deactivate CR
    alt Stocktake Not Found
        CS -> CS : throw new StocktakeNotFoundException(...)
        CS --> CC : return StocktakeNotFoundException
        CC --> UI : return 404 Not Found {error message}
        UI --> User : return error
    else Stocktake Found
        CS -> CS : update fields
        CS -> CR : save(stocktake)
        activate CR
        CR -> DB : UPDATE stocktakes SET ... WHERE id=?
        DB --> CR : return updated stocktake
        CR --> CS : return Stocktake entity
        deactivate CR
        CS -> CM : toResponseDto(stocktake)
        activate CM
        CM --> CS : return StocktakeResponseDto
        deactivate CM
        CS --> CC : return StocktakeResponseDto
        CC --> UI : return 200 OK StocktakeResponseDto
        UI --> User : return StocktakeResponseDto
    end
end
deactivate CS
deactivate CC
@enduml 