@startuml Report_All_Sequence

skinparam backgroundColor white
skinparam sequenceArrowThickness 2
skinparam sequenceMessageAlign center
skinparam sequenceGroupBodyBackgroundColor #F8F9FA
skinparam sequenceParticipantBorderColor #6C757D
skinparam sequenceParticipantBackgroundColor #E9ECEF
skinparam sequenceLifeLineStroke dash

title Report – Unified Sequence Diagram (7 Reports)

actor Staff
participant ":Reports UI (various pages)" as UI
participant ":ReportController" as RC
participant ":JwtAuthenticationService" as Auth
participant ":ReportServiceImpl" as RS
participant ":ImportTransactionDetailRepository" as DetailRepo
participant ":ImportTransactionRepository" as ImportRepo
participant ":SaleTransactionRepository" as SaleRepo
participant ":StocktakeRepository" as StocktakeRepo
participant ":ProductRepository" as ProductRepo
participant ":ZoneRepository" as ZoneRepo

== A. Daily Revenue ==
Staff -> UI: Chọn from(LocalDate), to(LocalDate), storeId(optional)
activate Staff
activate UI
UI -> RC: GET /api/reports/daily-revenue?from&to&storeId?
activate RC
RC -> RC: Normalize dates → from.atStartOfDay(), to.atTime(MAX)
RC -> Auth: extractAuthenticatedUser() + roles
activate Auth
Auth --> RC: User (roles)
deactivate Auth
RC -> RS: getDailyRevenue(fromDateTime, toDateTime, storeId?)
activate RS
RS -> RS: resolve storeId if STAFF
RS -> SaleRepo: findAllSaleActive() or findAllSaleActiveByStore(storeId)
activate SaleRepo
SaleRepo --> RS: List<SaleTransaction>
deactivate SaleRepo
RS -> ImportRepo: findAllImportActive() or findAllImportActiveByStore(storeId)
activate ImportRepo
ImportRepo --> RS: List<ImportTransaction>
deactivate ImportRepo
RS -> RS: sum totals → DailyRevenueDto(totalSale, totalImport, net)
RS --> RC: DailyRevenueDto
deactivate RS
RC --> UI: 200 OK DailyRevenueDto
deactivate RC
UI --> Staff: Render KPIs

== B. Sales Shift Total ==
UI -> RC: GET /api/reports/sales-total?from(LocalDateTime)&to(LocalDateTime)&groupBy&storeId?&cashierId?
activate RC
RC -> Auth: extractAuthenticatedUser() + roles
activate Auth
Auth --> RC: User (roles)
deactivate Auth
RC -> RS: getSalesTotal(from, to, groupBy, storeId?, cashierId?)
activate RS
RS -> RS: resolve storeId if STAFF; filter by cashierId if provided
RS -> SaleRepo: findAllSaleActive() or findAllSaleActiveByStore(storeId)
activate SaleRepo
SaleRepo --> RS: List<SaleTransaction>
deactivate SaleRepo
RS -> RS: group by (hour|cashier|shift); aggregate amount/count → List<SalesShiftTotalDto>
RS --> RC: List<SalesShiftTotalDto>
deactivate RS
RC --> UI: 200 OK List<SalesShiftTotalDto>
deactivate RC
UI --> Staff: Render chart/table

== C. Imports Total ==
UI -> RC: GET /api/reports/imports-total?from(LocalDate)&to(LocalDate)&groupBy(day|week|month)&storeId?&supplierId?
activate RC
RC -> RC: Normalize dates → from.atStartOfDay(), to.atTime(MAX)
RC -> Auth: extractAuthenticatedUser() + roles
activate Auth
Auth --> RC: User (roles)
deactivate Auth
RC -> RS: getImportsTotal(fromDateTime, toDateTime, groupBy, storeId?, supplierId?)
activate RS
RS -> RS: resolve storeId if STAFF
RS -> ImportRepo: findAllImportActive() or findAllImportActiveByStore(storeId)
activate ImportRepo
ImportRepo --> RS: List<ImportTransaction>
deactivate ImportRepo
RS -> RS: filter by date & supplier → group by bucket → List<GroupTotalDto>
RS --> RC: List<GroupTotalDto>
deactivate RS
RC --> UI: 200 OK List<GroupTotalDto>
deactivate RC
UI --> Staff: Render chart/table

== D. In/Out Summary ==
UI -> RC: GET /api/reports/inout-summary?from(LocalDate)&to(LocalDate)&storeId?
activate RC
RC -> RC: Normalize dates → from.atStartOfDay(), to.atTime(MAX)
RC -> Auth: extractAuthenticatedUser() + roles
activate Auth
Auth --> RC: User (roles)
deactivate Auth
RC -> RS: getInOutSummary(fromDateTime, toDateTime, storeId?)
activate RS
RS -> RS: resolve storeId if STAFF
RS -> ImportRepo: findAllImportActive() or findAllImportActiveByStore(storeId)
activate ImportRepo
ImportRepo --> RS: List<ImportTransaction>
deactivate ImportRepo
RS -> SaleRepo: findAllSaleActive() or findAllSaleActiveByStore(storeId)
activate SaleRepo
SaleRepo --> RS: List<SaleTransaction>
deactivate SaleRepo
RS -> RS: compute openingStock + per-day import/export + remain → List<InOutSummaryDto>
RS --> RC: List<InOutSummaryDto>
deactivate RS
RC --> UI: 200 OK List<InOutSummaryDto>
deactivate RC
UI --> Staff: Render area/line chart

== E. Remain Summary ==
UI -> RC: GET /api/reports/remain-summary
activate RC
RC -> RS: getRemainSummary()
activate RS
RS -> RS: resolve storeId if STAFF (from header)
RS -> DetailRepo: findByRemainQuantityGreaterThan(0)
activate DetailRepo
DetailRepo --> RS: List<ImportTransactionDetail>
deactivate DetailRepo
RS -> ProductRepo: findAll(); ZoneRepo: findAll()
RS -> RS: group Category → Product → Zone, split remain across zones → List<CategoryRemainSummaryDto>
RS --> RC: List<CategoryRemainSummaryDto>
deactivate RS
RC --> UI: 200 OK List<CategoryRemainSummaryDto>
deactivate RC
UI --> Staff: Render nested tables

== F. Expiring Lots ==
UI -> RC: GET /api/reports/expiring-lots?days&storeId?
activate RC
RC -> Auth: extractAuthenticatedUser() + roles
activate Auth
Auth --> RC: User (roles)
deactivate Auth
RC -> RS: getExpiringLots(days, storeId?)
activate RS
RS -> RS: resolve storeId if STAFF
RS -> DetailRepo: findExpiringLots(now, soon) or findExpiringLotsByStore(storeId, now, soon)
activate DetailRepo
DetailRepo --> RS: List<ImportTransactionDetail>
deactivate DetailRepo
RS -> ZoneRepo: findAll() (map zoneId -> zoneName)
RS -> RS: map → List<ExpiringLotDto>
RS --> RC: List<ExpiringLotDto>
deactivate RS
RC --> UI: 200 OK List<ExpiringLotDto>
deactivate RC
UI --> Staff: Render table + highlight

== G. Stocktake Diff ==
UI -> RC: GET /api/reports/stocktake-diff?stocktakeId?
activate RC
RC -> RS: getStocktakeDiffById(stocktakeId?)
activate RS
RS -> RS: if stocktakeId null → StocktakeRepo.findMaxId()
RS -> StocktakeRepo: findById(id)
activate StocktakeRepo
StocktakeRepo --> RS: Optional<Stocktake>
deactivate StocktakeRepo
alt Not found
  RS --> RC: []
  RC --> UI: 200 OK []
else Found
  RS -> RS: parse JSON detail → filter diff != 0
  RS -> ProductRepo: backfill product fields if missing (by productId)
  ProductRepo --> RS: Product
  RS --> RC: List<StocktakeDetailDto>
end
deactivate RS
RC --> UI: 200 OK List<StocktakeDetailDto>
deactivate RC
UI --> Staff: Render table

deactivate UI
deactivate Staff

@enduml 