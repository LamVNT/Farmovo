@startuml Stocktake_GetDetail_Sequence

skinparam backgroundColor white
skinparam sequenceArrowThickness 2
skinparam sequenceMessageAlign center
skinparam sequenceGroupBodyBackgroundColor #F8F9FA
skinparam sequenceParticipantBorderColor #6C757D
skinparam sequenceParticipantBackgroundColor #E9ECEF
skinparam sequenceLifeLineStroke dash
skinparam actorBackgroundColor #FFD700

title Get Stocktake Detail - Sequence Diagram

actor Staff
participant ":StockTake Page" as UI
participant ":Edit StockTake Page" as EditUI
participant ":Detail StockTake Page" as DetailUI
participant ":StocktakeController" as Controller
participant ":StocktakeServiceImpl" as Service
participant ":StocktakeRepository" as StocktakeRepo
participant ":ProductRepository" as ProductRepo
participant ":ZoneRepository" as ZoneRepo
participant ":StocktakeMapper" as Mapper

== Nhân viên chọn phiếu kiểm kê ==
Staff -> UI: Chọn kiểm kê, nhấn "Xem chi tiết"
activate Staff
activate UI

UI -> Controller: GET /api/stocktakes/{id}
activate Controller
Controller -> Service: getStocktake(id)
activate Service
Service -> StocktakeRepo: findById(id)
activate StocktakeRepo
StocktakeRepo --> Service: Optional<Stocktake>
deactivate StocktakeRepo

alt Không tìm thấy
    Service --> Controller: throw StocktakeNotFound
    Controller --> UI: 404 Not Found
    UI --> Staff: Hiển thị lỗi
    deactivate Service
    deactivate Controller
    deactivate UI
else Tìm thấy
    Service -> Mapper: toResponseDto(stocktake)
    activate Mapper
    Mapper --> Service: StocktakeResponseDto
    deactivate Mapper
    Service --> Controller: StocktakeResponseDto
    deactivate Service
    Controller --> UI: 200 OK
    deactivate Controller
end

== Xử lý theo trạng thái phiếu ==

alt Status == DRAFT
    UI -> EditUI: Điều hướng đến Edit StockTake Page
    deactivate UI
    activate EditUI

    EditUI -> Service: fetchProducts(storeId)
    activate Service
    Service -> ProductRepo: fetchProducts(storeId)
    activate ProductRepo
    ProductRepo --> Service: List<ProductDTO>
    deactivate ProductRepo
    Service --> EditUI: List<ProductDTO>

    EditUI -> Service: fetchZones(storeId)
    Service -> ZoneRepo: fetchZones(storeId)
    activate ZoneRepo
    ZoneRepo --> Service: List<ZoneDTO>
    deactivate ZoneRepo
    Service --> EditUI: List<ZoneDTO>
    deactivate Service

    EditUI -> Staff: Hiển thị form chỉnh sửa + dữ liệu

else Status == COMPLETED hoặc CANCELLED
    UI -> Controller: GET /api/stocktakes/{id}/details
    activate Controller
    Controller -> Service: getStocktakeDetails(id)
    activate Service
    Service -> StocktakeRepo: findById(id)
    activate StocktakeRepo
    StocktakeRepo --> Service: Optional<Stocktake>
    deactivate StocktakeRepo

    alt Không tìm thấy
        Service --> Controller: throw StocktakeNotFound
        Controller --> UI: 404 Not Found
        UI --> Staff: Hiển thị lỗi
        deactivate Service
        deactivate Controller
    else Tìm thấy
        Service -> Service: parse JSON detail
        Service -> Mapper: toDetailDto(detail)
        activate Mapper
        Mapper --> Service: List<StocktakeDetailDto>
        deactivate Mapper
        Service --> Controller: List<StocktakeDetailDto>
        deactivate Service
        Controller --> UI: 200 OK
        deactivate Controller

        UI -> DetailUI: Điều hướng đến Detail Page
        deactivate UI
        activate DetailUI
        DetailUI -> Staff: Hiển thị dữ liệu chi tiết (readonly)
    end
end

deactivate DetailUI
deactivate EditUI
deactivate Staff

note right of EditUI
StocktakeResponseDto:
- id, stocktakeDate
- detail, note
- storeId, status (DRAFT, COMPLETED, CANCELLED)
end note

note right of DetailUI
StocktakeDetailDto:
- Thông tin chi tiết, chỉ đọc
end note

@enduml
