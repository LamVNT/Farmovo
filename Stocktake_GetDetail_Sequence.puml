@startuml Stocktake_GetDetail_Sequence

skinparam backgroundColor white
skinparam sequenceArrowThickness 2
skinparam sequenceMessageAlign center
skinparam sequenceGroupBodyBackgroundColor #F8F9FA
skinparam sequenceParticipantBorderColor #6C757D
skinparam sequenceParticipantBackgroundColor #E9ECEF
skinparam sequenceLifeLineStroke dash

title Get Stocktake Detail - Sequence Diagram (Detail + CanBalance + Export)

actor Staff
participant ":StockTake List Page" as ListUI
participant ":Detail StockTake Page" as DetailUI
participant ":Stocktake Edit Page" as EditUI
participant ":StocktakeController" as Controller
participant ":StocktakeServiceImpl" as Service
participant ":StocktakeRepository" as StocktakeRepo
participant ":StocktakeMapper" as Mapper
participant ":MasterDataController" as MasterDataCtrl
participant ":MasterDataService" as MasterDataSvc
participant ":MasterDataRepository" as MasterDataRepo
participant ":Balance Page" as BALANCE_UI

== Chọn phiếu kiểm kê ==
Staff -> ListUI: Click một dòng kiểm kê
activate Staff
activate ListUI
opt Nếu status == DRAFT
  ListUI -> EditUI: Điều hướng /stocktake/edit/{id}
end
ListUI -> DetailUI: Điều hướng /stocktake/{id}
deactivate ListUI
activate DetailUI

== A. Load dữ liệu ban đầu ==
DetailUI -> MasterDataCtrl: GET /api/master-data
activate MasterDataCtrl
MasterDataCtrl -> MasterDataSvc: getMasterData(userRole)
activate MasterDataSvc
MasterDataSvc -> MasterDataRepo: fetchAllMasterData()
activate MasterDataRepo
MasterDataRepo --> MasterDataSvc: MasterDataDTO
deactivate MasterDataRepo
MasterDataSvc --> MasterDataCtrl: MasterDataDTO {Products, Zones, Stores?, Categories}
deactivate MasterDataSvc
MasterDataCtrl --> DetailUI: MasterDataDTO
deactivate MasterDataCtrl

== B. Tải chi tiết ==
DetailUI -> Controller: GET /api/stocktakes/{id}
activate Controller
Controller -> Service: getStocktakeById(id)
activate Service
Service -> StocktakeRepo: findById(id)
activate StocktakeRepo
StocktakeRepo --> Service: Optional<Stocktake>
deactivate StocktakeRepo
alt Không tìm thấy
    Service --> Controller: throw ValidationException("Stocktake not found")
    Controller --> DetailUI: 404 Not Found
    DetailUI --> Staff: Hiển thị lỗi
    deactivate Service
    deactivate Controller
else Tìm thấy
    Service -> Mapper: toResponseDto(stocktake)
    activate Mapper
    Mapper --> Service: StocktakeResponseDto
    deactivate Mapper
    Service --> Controller: StocktakeResponseDto
    deactivate Service
    Controller --> DetailUI: 200 OK
    deactivate Controller
    DetailUI --> Staff: Hiển thị thông tin chi tiết
end

== C. Logic hiển thị hành động ==
note right of DetailUI
  canBalance = (status == COMPLETED)
               AND (tồn tại dòng diff != 0)
               AND (hasBalance == false)
end note
DetailUI --> Staff: Hiển thị nút "Cân bằng kho (Tạo PCB)" nếu canBalance

opt Staff bấm Cân bằng kho
  DetailUI -> BALANCE_UI: Điều hướng /sale/balance/{stocktakeId}
end

opt Export Excel (khi COMPLETED)
  Staff -> DetailUI: Bấm "Export Excel"
  DetailUI -> Controller: GET /api/stocktakes/{id}/export-excel
  activate Controller
  Controller -> Service: exportStocktakeToExcel(id)
  activate Service
  Service --> Controller: ResponseEntity<ByteArrayResource>
  deactivate Service
  Controller --> DetailUI: 200 OK (file)
  deactivate Controller
  DetailUI --> Staff: Tải file Excel
end

deactivate DetailUI
deactivate Staff

@enduml
