@startuml Stocktake_Cancel_Sequence

skinparam backgroundColor white
skinparam sequenceArrowThickness 2
skinparam sequenceMessageAlign center
skinparam sequenceGroupBodyBackgroundColor #F8F9FA
skinparam sequenceParticipantBorderColor #6C757D
skinparam sequenceParticipantBackgroundColor #E9ECEF
skinparam sequenceLifeLineStroke dash
skinparam actorBackgroundColor #FFD700

title Cancel StockTake - Sequence Diagram

actor Staff
participant ":StockTake Page" as UI
participant ":StocktakeController" as Controller
participant ":StocktakeServiceImpl" as Service
participant ":StocktakeRepository" as StocktakeRepo
participant ":StocktakeMapper" as Mapper

== Nhân viên hủy kiểm kê ==
Staff -> UI: Nhấn "Hủy kiểm kê"
activate Staff
activate UI

UI -> Controller: PUT /api/stocktakes/{id}/cancel
activate Controller
Controller -> Service: cancelStocktake(id)
activate Service

Service -> StocktakeRepo: findById(id)
activate StocktakeRepo
StocktakeRepo --> Service: Optional<Stocktake>
deactivate StocktakeRepo

alt Không tìm thấy
    Service --> Controller: throw StocktakeNotFoundException
    Controller --> UI: 404 Not Found
    UI --> Staff: Hiển thị lỗi
    deactivate Service
    deactivate Controller
else Tìm thấy
    Service -> Service: check status == DRAFT

    alt Status không hợp lệ
        Service --> Controller: throw InvalidStatusException
        Controller --> UI: 400 Bad Request {"Only DRAFT can be cancelled"}
        UI --> Staff: Hiển thị lỗi
        deactivate Service
        deactivate Controller
    else Status hợp lệ
        Service -> Service: setStatus(CANCELLED), setUpdatedAt
        Service -> StocktakeRepo: save(stocktake)
        activate StocktakeRepo

        alt Lỗi khi lưu
            StocktakeRepo --> Service: throw SaveException
            Service --> Controller: 500 Internal Server Error
            Controller --> UI: 500 Internal Server Error
            UI --> Staff: Hiển thị lỗi
            deactivate StocktakeRepo
            deactivate Service
            deactivate Controller
        else Lưu thành công
            StocktakeRepo --> Service: Stocktake
            deactivate StocktakeRepo

            Service -> Mapper: toResponseDto(stocktake)
            activate Mapper
            Mapper --> Service: StocktakeResponseDto
            deactivate Mapper

            Service --> Controller: StocktakeResponseDto
            deactivate Service

            Controller --> UI: 200 OK StocktakeResponseDto
            UI --> Staff: Hiển thị trạng thái CANCELLED
            deactivate Controller
        end
    end
end

deactivate UI
deactivate Staff

note right of UI
StocktakeResponseDto:
- id, stocktakeDate, detail, note, storeId, status
- status gồm: DRAFT, CANCELLED, COMPLETED
end note

@enduml
