@startuml Stocktake_Cancel_Sequence

skinparam backgroundColor white
skinparam sequenceArrowThickness 2
skinparam sequenceMessageAlign center
skinparam sequenceGroupBodyBackgroundColor #F8F9FA
skinparam sequenceParticipantBorderColor #6C757D
skinparam sequenceParticipantBackgroundColor #E9ECEF
skinparam sequenceLifeLineStroke dash

title Cancel StockTake - Sequence Diagram (Status Change)

actor Staff
participant ":StockTake Detail Page" as UI
participant ":StocktakeController" as Controller
participant ":StocktakeServiceImpl" as Service
participant ":StocktakeRepository" as StocktakeRepo
participant ":StocktakeMapper" as Mapper

== Nhân viên hủy kiểm kê ==
Staff -> UI: Nhấn "Hủy kiểm kê"
activate Staff
activate UI

UI -> Controller: PUT /api/stocktakes/{id}/status?status=CANCELLED
activate Controller
Controller -> Service: updateStocktakeStatus(id, CANCELLED, userId)
activate Service

Service -> StocktakeRepo: findById(id)
activate StocktakeRepo
StocktakeRepo --> Service: Optional<Stocktake>
deactivate StocktakeRepo

alt Không tìm thấy
    Service --> Controller: throw ValidationException("Stocktake not found")
    Controller --> UI: 404 Not Found
    UI --> Staff: Hiển thị lỗi
    deactivate Service
    deactivate Controller
else Tìm thấy
    Service -> Service: validateStatusTransition(old, CANCELLED, user)
    alt Không hợp lệ
        Service --> Controller: throw ValidationException
        Controller --> UI: 400 Bad Request
        UI --> Staff: Hiển thị lỗi
        deactivate Service
        deactivate Controller
    else Hợp lệ
        Service -> Service: setStatus(CANCELLED)
        Service -> StocktakeRepo: save(stocktake)
        activate StocktakeRepo
        StocktakeRepo --> Service: Stocktake
        deactivate StocktakeRepo

        Service -> Mapper: toResponseDto(stocktake)
        activate Mapper
        Mapper --> Service: StocktakeResponseDto
        deactivate Mapper

        Service --> Controller: StocktakeResponseDto
        deactivate Service

        Controller --> UI: 200 OK StocktakeResponseDto
        deactivate Controller
        UI --> Staff: Hiển thị trạng thái CANCELLED
    end
end

deactivate UI
deactivate Staff

note right of UI
StocktakeResponseDto:
- id, name, stocktakeDate, detail, note, storeName, status
- status gồm: DRAFT, CANCELLED, COMPLETED
end note

@enduml
