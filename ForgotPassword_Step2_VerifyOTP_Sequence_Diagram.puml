@startuml ForgotPassword_Step2_VerifyOTP_Sequence_Diagram

!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequence {
    ArrowColor #495057
    ActorBorderColor #6C757D
    LifeLineBorderColor #6C757D
    ParticipantBorderColor #6C757D
    ParticipantBackgroundColor #F8F9FA
}

title **Forgot Password - Step 2: Verify OTP**

actor User as U
participant "Frontend" as F
participant "ForgotPasswordController" as C
participant "OtpValidator" as OV
participant "ForgotPasswordService" as FPS
participant "UserRepository" as UR
participant "ForgotPasswordRepository" as FPR

U -> F: Enter OTP code
F -> C: POST /verifyOtp/{email} + OTP
activate C

C -> OV: validateOtp(request)
activate OV
OV -> OV: Validate OTP format
note right: Check if OTP is 6 digits\nand numeric only
OV --> C: Validation result
deactivate OV

alt OTP format invalid
    C --> F: Error: "Invalid OTP format"
    F --> U: Display error message
else OTP format valid
    C -> FPS: verifyOtp(otp, email)
    activate FPS
    
    FPS -> UR: findByEmail(email)
    activate UR
    UR --> FPS: User object
    deactivate UR
    
    FPS -> FPR: findByOtpAndUser(otp, user)
    activate FPR
    FPR --> FPS: ForgotPassword object
    deactivate FPR
    
    alt OTP expired
        FPS -> FPR: delete(fp)
        activate FPR
        FPR --> FPS: Deleted
        deactivate FPR
        FPS --> C: "OTP expired"
    else OTP valid
        FPS -> FPR: delete(fp)
        activate FPR
        FPR --> FPS: Deleted
        deactivate FPR
        FPS --> C: "OTP verified successfully"
    end
    deactivate FPS
    
    alt OTP verified
        C --> F: Success response
        F --> U: Display success message
    else OTP invalid/expired
        C --> F: Error response
        F --> U: Display error message
    end
end
deactivate C

@enduml

