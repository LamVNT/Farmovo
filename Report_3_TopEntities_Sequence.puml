@startuml Report_3_TopEntities_Sequence

skinparam backgroundColor white
skinparam sequenceArrowThickness 2
skinparam sequenceMessageAlign center
skinparam sequenceGroupBodyBackgroundColor #F8F9FA
skinparam sequenceParticipantBorderColor #6C757D
skinparam sequenceParticipantBackgroundColor #E9ECEF
skinparam sequenceLifeLineStroke dash

title Report 3: Top Entities (Products / Customers)

actor User
participant ":Reports Page" as UI
participant ":ReportController" as RC
participant ":ReportServiceImpl" as RS
participant ":ImportTransactionDetailRepository" as DetailRepo
participant ":SaleTransactionRepository" as SaleRepo

User -> UI: Chọn khoảng thời gian + limit; chọn tab [Products|Customers]
alt Tab = Products
  UI -> RC: GET /api/reports/top-products?from=...&to=...&limit=...
  activate RC
  RC -> RS: getTopProducts(from.atStartOfDay, to.atEndOfDay, limit)
  activate RS
  RS -> DetailRepo: Aggregate quantity by product
  DetailRepo --> RS: List<Object[]>
  RS -> RS: Map -> List<TopProductDto>
  RS --> RC: List<TopProductDto>
  RC --> UI: 200 OK
  UI --> User: Render bảng/biểu đồ Top sản phẩm
else Tab = Customers
  UI -> RC: GET /api/reports/top-customers?from=...&to=...&limit=...
  activate RC
  RC -> RS: getTopCustomers(from.atStartOfDay, to.atEndOfDay, limit)
  activate RS
  RS -> SaleRepo: Aggregate amount/count by customer
  SaleRepo --> RS: List<Object[]>
  RS -> RS: Map -> List<TopCustomerDto>
  RS --> RC: List<TopCustomerDto>
  RC --> UI: 200 OK
  UI --> User: Render bảng Top khách hàng
end

@enduml
